name: CI

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  repo-sanity:
    name: Repo Sanity Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify required repository files
        run: |
          set -euo pipefail
          required_files=(
            "README.md"
            ".context/TASKS.md"
            "docs/ARCHITECTURE.md"
            "docs/DECISIONS.md"
            "docs/STRUCTURE.md"
          )

          for path in "${required_files[@]}"; do
            if [[ ! -f "${path}" ]]; then
              echo "Missing required file: ${path}" >&2
              exit 1
            fi
          done

      - name: Block unresolved merge conflict markers
        run: |
          set -euo pipefail
          if git grep -nE '^(<<<<<<<|=======|>>>>>>>)' -- .; then
            echo "Unresolved merge conflict markers detected." >&2
            exit 1
          fi

      - name: Check trailing whitespace in tracked docs/workflow files
        run: |
          set -euo pipefail
          files="$(git ls-files '*.md' '*.yml' '*.yaml')"
          if [[ -z "${files}" ]]; then
            echo "No markdown/yaml files found to check."
            exit 0
          fi

          if printf '%s\n' "${files}" | xargs awk '/[[:blank:]]+$/{print FILENAME ":" FNR ":" $0; found=1} END{exit found}'; then
            echo "No trailing whitespace detected."
          else
            echo "Trailing whitespace detected in listed files." >&2
            exit 1
          fi

  python-tests:
    name: Python Tests (when present)
    runs-on: ubuntu-latest
    needs:
      - repo-sanity
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect Python sources
        id: detect-python
        run: |
          set -euo pipefail
          py_file_count="$(git ls-files 'app/**/*.py' 'tests/**/*.py' | wc -l | tr -d ' ')"
          if [[ "${py_file_count}" -gt 0 ]]; then
            echo "has_python=true" >> "${GITHUB_OUTPUT}"
          else
            echo "has_python=false" >> "${GITHUB_OUTPUT}"
          fi

      - name: Setup Python
        if: ${{ steps.detect-python.outputs.has_python == 'true' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        if: ${{ steps.detect-python.outputs.has_python == 'true' }}
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run tests
        if: ${{ steps.detect-python.outputs.has_python == 'true' }}
        run: pytest tests/ -v

      - name: Skip Python checks (no Python files detected)
        if: ${{ steps.detect-python.outputs.has_python != 'true' }}
        run: echo "No Python files under app/ or tests/. Skipping python-tests job steps."

  container-smoke:
    name: Container Smoke
    runs-on: ubuntu-latest
    needs:
      - repo-sanity
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build app image
        run: docker build -t policy-mesh-app .

      - name: Start app service
        run: docker compose up -d app

      - name: Wait for readiness
        run: |
          set -euo pipefail
          for i in $(seq 1 15); do
            if curl -sf http://127.0.0.1:8000/v1/health -o /tmp/health.json 2>/dev/null; then
              break
            fi
            if [[ "$i" -eq 15 ]]; then
              echo "Health endpoint not ready after 15 attempts" >&2
              exit 1
            fi
            sleep 2
          done

      - name: Assert health response
        run: |
          set -euo pipefail
          body="$(cat /tmp/health.json)"
          expected='{"status":"ok"}'
          if [[ "$body" != "$expected" ]]; then
            echo "Expected: $expected" >&2
            echo "Got:      $body" >&2
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: docker compose down
